<!DOCTYPE html>
<div id="app">
  <h1>My TODO</h1>
  <p>
    <!-- ナビゲーション向けに v-link ディレクティブを使用 -->
    <a v-link="{ path: '/' }">Go to First</a>
    <a v-link="{ path: '/bar' }">Go to Bar</a>
  </p>
  <!-- route outlet -->
  <router-view></router-view>
</div>

<template id="login-template">
  <a v-link="{ path: '/foo' }">Login</a>
</template>

<template id="tasklist-template">
  <h3>今日 {{today}} <input type="text" name="todays_new_task" v-model="todaysNewtaskName" /><button v-on:click="addTodaysNewTask">add</button></h3>
  <ul>
    <li v-for="task in todayTaskList" style="{{task.task_completed_date_optional ? 'text-decoration: line-through;' : ''}}">
      {{ task.task_name }} {{task.task_end_date_optional}}
    </li>
  </ul>

  <hr>
  <h3>明日 {{day2}}</h3>
  <ul>
    <li v-for="task in day2TaskList" style="{{task.task_completed_date_optional ? 'text-decoration: line-through;' : ''}}">
      {{ task.task_name }} {{task.task_end_date_optional}}
    </li>
  </ul>

  <hr>
  <h3>明後日 {{day3}}</h3>
  <ul>
    <li v-for="task in day3TaskList" style="{{task.task_completed_date_optional ? 'text-decoration: line-through;' : ''}}">
      {{ task.task_name }} {{task.task_end_date_optional}}
    </li>
  </ul>

  <hr>
  <h3>3日後 {{day4}}</h3>
  <ul>
    <li v-for="task in day4TaskList" style="{{task.task_completed_date_optional ? 'text-decoration: line-through;' : ''}}">
      {{ task.task_name }} {{task.task_end_date_optional}}
    </li>
  </ul>

  <hr>
  <h3>4日後 {{day5}}</h3>
  <ul>
    <li v-for="task in day5TaskList" style="{{task.task_completed_date_optional ? 'text-decoration: line-through;' : ''}}">
      {{ task.task_name }} {{task.task_end_date_optional}}
    </li>
  </ul>

  <hr>
  <h3>5日後 {{day6}}</h3>
  <ul>
    <li v-for="task in day6TaskList" style="{{task.task_completed_date_optional ? 'text-decoration: line-through;' : ''}}">
      {{ task.task_name }} {{task.task_end_date_optional}}
    </li>
  </ul>

  <hr>
  <h3>6日後 {{day7}}</h3>
  <ul>
    <li v-for="task in day7TaskList" style="{{task.task_completed_date_optional ? 'text-decoration: line-through;' : ''}}">
      {{ task.task_name }} {{task.task_end_date_optional}}
    </li>
  </ul>

  <hr>
  <h3>以降</h3>
  <ul>
    <li v-for="task in otherTaskList" style="{{task.task_completed_date_optional ? 'text-decoration: line-through;' : ''}}">
      {{ task.task_name }} {{task.task_end_date_optional}}
    </li>
  </ul>

  <hr>
  <h3>BACKLOG</h3>
  <ul>
    <li v-for="task in backlogTaskList" style="{{task.task_completed_date_optional ? 'text-decoration: line-through;' : ''}}">
      {{ task.task_name }} {{task.task_end_date_optional}}
    </li>
  </ul>
</template>

<script src="https://cdn.jsdelivr.net/vue/1.0.26/vue.min.js"></script>
<script src="https://cdn.jsdelivr.net/vue.router/0.7.10/vue-router.min.js"></script>
<script src="https://cdn.jsdelivr.net/vue.resource/0.9.3/vue-resource.min.js"></script>
<script>
var serverResponseSample = [];
var model = {
  auth: {
    token: null,
    checkToken: {
      result: false,
      checkStartDate: null,
      lastCheckDate: null
    }
  },
  taskList: [],
  todaysNewtaskName: ''
}

var formatDate = function(format, date) {
  var year = date.getFullYear();
  var month = ("0" + (date.getMonth() + 1)).slice(-2);
  var dayofmonth = ("0" + date.getDate()).slice(-2);
  return format.split('YYYY').join(year).split('MM').join(month).split('DD').join(dayofmonth);
}

var First = Vue.extend({
  template: '#login-template',
  data: () => model,
  created: function() {

    if(this.$data.auth.token) {
      // トークンが有れば次へ
      router.go('/main');
    } else {
      // 無ければログイン
      // flob取得
      // サーバ
    }
  }
})
// いくつかのコンポーネントを定義します
// var Login = Vue.extend({
//     template: '#login-template'
// })

var TaskRepository = function() {
  var urlbase = 'http://localhost:4567/api/v1/jsonp';
  var getTaskList = function(vue, success, error) {
    vue.$http.jsonp(`${urlbase}/task/list?token=${model.auth.token}`).then(
      (data, status, request) => success(data.data, status),
      () => error(data.data, status)
    );
  };

  var addTask = function(vue, name, enddate, success, error) {
    vue.$http.jsonp(`${urlbase}/task/add?token=${model.auth.token}&name=${name}&enddate=${enddate}`).then(
      (data, status, request) => success(data.data, status),
      (data, status, request) => error(data.data, status)
    );
  }
  return {
    getTaskList: getTaskList,
    addTask: addTask
  };
};

var taskRepository = TaskRepository();

var day = (num) => new Date(Date.now() + 24 * 60 * 60 * 1000 * num);
var formatedDay = (num) => formatDate('MM/DD', day(num));

var Main = Vue.extend({
    template: '#tasklist-template',
    data: () => model,
    watch: {
      'auth.token': (val, oldVal) => {
        if(!val) {
          router.go('/');
        }
      }
    },
    methods: {
      addTodaysNewTask: function() {
        this.todaysNewtaskName = this.todaysNewtaskName.trim();
        if(this.todaysNewtaskName.length == 0) {
          return;
        }
        taskRepository.addTask(
          this,
          this.todaysNewtaskName,
          formatDate('YYYY-MM-DD', day(0)),
          (data) => {
            var v = data.detail[0]
            if(v.task_end_date_optional) {
              v.task_end_date_optional = new Date(v.task_end_date_optional)
            }
            if(v.task_completed_date_optional) {
              v.task_completed_date_optional = new Date(v.task_completed_date_optional)
            }
            this.taskList.push(v);
            console.log(v);
          },
          (data) => {}
        );
        console.log(this.todaysNewtaskName);
      }
    },
    computed: {
      today: () => formatedDay(0),
      day2: () => formatedDay(1),
      day3: () => formatedDay(2),
      day4: () => formatedDay(3),
      day5: () => formatedDay(4),
      day6: () => formatedDay(5),
      day7: () => formatedDay(6),
      todayTaskList: function() {
        var nextDay = new Date(Date.now() + 24 * 60 * 60 * 1000);
        var end = new Date(formatDate('YYYY-MM-DD 00:00:00', nextDay));
        console.log(end);
        return this.taskList.filter(v => {
          if(!v.task_end_date_optional) return false;
          console.log(end, v.task_end_date_optional, end.getTime(), v.task_end_date_optional.getTime());
          return  v.task_end_date_optional.getTime() < end.getTime();
        })
      },
      day2TaskList: function() {
        var start = new Date(formatDate('YYYY-MM-DD 00:00:00', day(1)));
        var end   = new Date(formatDate('YYYY-MM-DD 00:00:00', day(2)));
        return this.taskList.filter(v => {
          if(!v.task_end_date_optional) return false;
          return start.getTime() <= v.task_end_date_optional.getTime() && v.task_end_date_optional.getTime() < end.getTime();
        })
      },
      day3TaskList: function() {
        var start = new Date(formatDate('YYYY-MM-DD 00:00:00', day(2)));
        var end   = new Date(formatDate('YYYY-MM-DD 00:00:00', day(3)));
        return this.taskList.filter(v => {
          if(!v.task_end_date_optional) return false;
          return start.getTime() <= v.task_end_date_optional.getTime() && v.task_end_date_optional.getTime() < end.getTime();
        })
      },
      day4TaskList: function() {
        var start = new Date(formatDate('YYYY-MM-DD 00:00:00', day(3)));
        var end   = new Date(formatDate('YYYY-MM-DD 00:00:00', day(4)));
        return this.taskList.filter(v => {
          if(!v.task_end_date_optional) return false;
          return start.getTime() <= v.task_end_date_optional.getTime() && v.task_end_date_optional.getTime() < end.getTime();
        })
      },
      day5TaskList: function() {
        var start = new Date(formatDate('YYYY-MM-DD 00:00:00', day(4)));
        var end   = new Date(formatDate('YYYY-MM-DD 00:00:00', day(5)));
        return this.taskList.filter(v => {
          if(!v.task_end_date_optional) return false;
          return start.getTime() <= v.task_end_date_optional.getTime() && v.task_end_date_optional.getTime() < end.getTime();
        })
      },
      day6TaskList: function() {
        var start = new Date(formatDate('YYYY-MM-DD 00:00:00', day(5)));
        var end   = new Date(formatDate('YYYY-MM-DD 00:00:00', day(6)));
        return this.taskList.filter(v => {
          if(!v.task_end_date_optional) return false;
          return start.getTime() <= v.task_end_date_optional.getTime() && v.task_end_date_optional.getTime() < end.getTime();
        })
      },
      day7TaskList: function() {
        var start = new Date(formatDate('YYYY-MM-DD 00:00:00', day(6)));
        var end   = new Date(formatDate('YYYY-MM-DD 00:00:00', day(7)));
        return this.taskList.filter(v => {
          if(!v.task_end_date_optional) return false;
          return start.getTime() <= v.task_end_date_optional.getTime() && v.task_end_date_optional.getTime() < end.getTime();
        })
      },
      otherTaskList: function() {
        var start = new Date(formatDate('YYYY-MM-DD 00:00:00', day(7)));
        return this.taskList.filter(v => {
          if(!v.task_end_date_optional) return false;
          return start.getTime() <= v.task_end_date_optional.getTime();
        })
      },
      backlogTaskList: function() {
        return this.taskList.filter(v => !v.task_end_date_optional)
      },
    }
    ,created: function() {
      console.log("created main");

      taskRepository.getTaskList(this, function (data, status, request) {
                //GETメソッドが成功した場合の処理
                // console.log(data.data.header.code);
                console.log(JSON.stringify(data.detail));
                var taskList = data.detail.map((v) => {
                  if(v.task_end_date_optional) {
                    v.task_end_date_optional = new Date(v.task_end_date_optional)
                  }
                  if(v.task_completed_date_optional) {
                    v.task_completed_date_optional = new Date(v.task_completed_date_optional)
                  }
                  return v;
                })
                .filter((v) => {
                  if(!v.task_completed_date_optional) {
                    return true;
                  }
                  // 24時間以上過去は切る
                  return Date.now() - 24 * 60 * 60 * 1000 - v.task_completed_date_optional.getTime() < 0;
                })
                .sort((a, b) => {// 下ならプラスを返す
                  if(a.task_end_date_optional && !b.task_end_date_optional) {
                    return -1;
                  }
                  if(!a.task_end_date_optional && b.task_end_date_optional) {
                    return 1;
                  }
                  if(!a.task_end_date_optional && !b.task_end_date_optional) {
                    if(a.task_id < b.task_id) return -1;
                    if(a.task_id == b.task_id) return 0;
                    if(a.task_id > b.task_id) return 1;
                  }
                  return a.task_end_date_optional.getTime() - b.task_end_date_optional.getTime();
                });
                model.taskList = taskList;
            }, function (data, status, request) {
                //GETメソッドが失敗した場合の処理
                console.log(data);
      })
    }
})


// router は、レンダリングするために1つの root コンポーネントが必要です
// デモ目的向けで、app テンプレートとして HTML を使用しているため、空を使用します
var App = Vue.extend({})

// router インスタンスを作成。
// ここでは追加的なオプションで渡すことができますが、今はシンプルに保っています
var router = new VueRouter()
router.map({
  '/': {
    component: First
  },
    '/main': {
        component: Main
    }
})
router.start(App, '#app')


</script>
